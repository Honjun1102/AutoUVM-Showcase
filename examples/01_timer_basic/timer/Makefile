# Makefile generated by AutoUVM 3.0

VCS_DEFINES = 
# Coverage options: line, condition, fsm, toggle, branch
VCS_COV_OPTIONS = -cm line+cond+fsm+tgl+branch -cm_dir simv.vdb
VCS = vcs -full64 -sverilog -ntb_opts uvm -timescale=1ns/1ps $(VCS_DEFINES) $(VCS_COV_OPTIONS)
VCS_DPI_SRCS = 
UVM_HOME ?= $(shell echo $$UVM_HOME)

# Directories
OUT_DIR = .
RTL_DIR = ../rtl
ENABLE_DUT ?= 0
TB_TOP ?= tb_top
FILELIST = filelist.f
REPO_ROOT = 
RTL_PRIORITY_FILES = 
OT_CORE_PATH = 
CAPI2_CORE_PATH = 
CAPI2_HW_ROOT = 
EXT_FILELIST_SCRIPT = 
EXT_FILELIST_ARGS = 

# Include paths
INCDIR = +incdir+$(UVM_HOME)/src +incdir+$(OUT_DIR) \
    +incdir+$(OUT_DIR)/agents \
    +incdir+$(OUT_DIR)/agents/apb_agent \
    +incdir+$(OUT_DIR)/components \
    +incdir+$(OUT_DIR)/env \
    +incdir+$(OUT_DIR)/interfaces \
    +incdir+$(OUT_DIR)/ral \
    +incdir+$(OUT_DIR)/rtl \
    +incdir+$(OUT_DIR)/scoreboards \
    +incdir+$(OUT_DIR)/tests

# Source files
SRCS = \
    interfaces/autouvm_clk_rst_if.sv \
    interfaces/apb_if.sv \
    agents/apb_agent/apb_agent_pkg.sv \
    env/timer_env_pkg.sv \
    tests/timer_base_test.sv \
    tb_top.sv

all: compile

compile:
	@rm -f "$(FILELIST)"
	@# Write a VCS filelist to avoid ARG_MAX issues on large RTLs (e.g. OpenTitan).
	@for x in $(INCDIR); do echo "$$x" >> "$(FILELIST)"; done
	@if [ "$(ENABLE_DUT)" = "1" ]; then \
		echo "[Makefile] DUT mode enabled: compiling RTL from $(RTL_DIR)"; \
		# Always honor RTL_PRIORITY_FILES even in fallback directory-scan mode. \
		for p in $(RTL_PRIORITY_FILES); do if [ -f "$$p" ]; then echo "$$p" >> "$(FILELIST)"; else echo "[Makefile] WARN: missing rtl_priority_file $$p"; fi; done; \
		# Prefer core/filelist closure when available (more deterministic than directory scanning). \
		RTL_LIST=rtl_filelist.f; RTL_INC=rtl_incdirs.f; \
		PREPEND_ARGS=""; for p in $(RTL_PRIORITY_FILES); do if [ -f "$$p" ]; then PREPEND_ARGS="$$PREPEND_ARGS --prepend $$p"; else echo "[Makefile] WARN: missing rtl_priority_file $$p"; fi; done; \
		if [ -n "$(EXT_FILELIST_SCRIPT)" ]; then \
		  echo "[Makefile] ext_filelist_script=$(EXT_FILELIST_SCRIPT)"; \
		  PYBIN="$${PYTHON:-python3}"; \
		  SCRIPT="$(EXT_FILELIST_SCRIPT)"; \
		  if [ -n "$$SCRIPT" ] && [ "$${SCRIPT#/}" = "$$SCRIPT" ]; then SCRIPT="$(REPO_ROOT)/$$SCRIPT"; fi; \
		  if [ -z "$$SCRIPT" ] || [ ! -f "$$SCRIPT" ]; then echo "[Makefile] ERROR: ext_filelist_script not found: $$SCRIPT"; exit 2; fi; \
		  $$PYBIN "$$SCRIPT" $(EXT_FILELIST_ARGS) --out "$$RTL_LIST" --out-inc "$$RTL_INC"; \
		  cat "$$RTL_INC" >> "$(FILELIST)"; \
		  cat "$$RTL_LIST" >> "$(FILELIST)"; \
		elif [ -n "$(OT_CORE_PATH)" ] || [ -n "$(CAPI2_CORE_PATH)" ]; then \
		  PYBIN="$${PYTHON:-python3}"; \
		  CORE_TOOL="$(REPO_ROOT)/scripts/opentitan_core_to_filelist.py"; \
		  if [ -z "$(REPO_ROOT)" ] || [ ! -f "$$CORE_TOOL" ]; then \
		    echo "[Makefile] ERROR: missing REPO_ROOT/scripts/opentitan_core_to_filelist.py (repo_root not set?)"; exit 2; \
		  fi; \
		  if [ -n "$(OT_CORE_PATH)" ]; then \
		    $$PYBIN "$$CORE_TOOL" --hw-root "$(RTL_DIR)" --top-core "$(OT_CORE_PATH)" --out "$$RTL_LIST" --out-inc "$$RTL_INC" $$PREPEND_ARGS; \
		  else \
		    $$PYBIN "$$CORE_TOOL" --hw-root "$(CAPI2_HW_ROOT)" --top-core "$(CAPI2_CORE_PATH)" --out "$$RTL_LIST" --out-inc "$$RTL_INC" $$PREPEND_ARGS; \
		  fi; \
		  cat "$$RTL_INC" >> "$(FILELIST)"; \
		  cat "$$RTL_LIST" >> "$(FILELIST)"; \
		else \
		  # Fallback: directory scan (best-effort) \
		  { \
		    find "$(RTL_DIR)" -type d -print 2>/dev/null | sed 's,^,+incdir+,'; \
		    find "$(RTL_DIR)" -type f -name "*.sv" -o -type f -name "*.v" 2>/dev/null; \
		  } >> "$(FILELIST)"; \
		fi; \
	fi
	@for f in $(SRCS); do echo "$$f" >> "$(FILELIST)"; done
	@# De-dup filelist lines (priority files may also appear in find output).
	@awk '!seen[$$0]++' "$(FILELIST)" > "$(FILELIST).uniq" && mv "$(FILELIST).uniq" "$(FILELIST)"
	@# Wrap VCS compilation with timeout if available (prevents CI hangs).
	@bash -c 'vcs_cmd="$(VCS) -f \"$(FILELIST)\" -top \"$(TB_TOP)\" $(VCS_DPI_SRCS) -l compile.log"; \
	  if command -v timeout >/dev/null 2>&1; then \
	    echo "[Makefile] Compiling with timeout: $(COMPILE_TIMEOUT_S)s"; \
	    timeout --preserve-status -k 10s $(COMPILE_TIMEOUT_S)s bash -c "$$vcs_cmd"; \
	  else \
	    echo "[Makefile] Compiling (no timeout available)"; \
	    eval "$$vcs_cmd"; \
	  fi'

# Run simulation
TEST ?= timer_base_test
AUTO_TXN_N ?= 50
SIM_SEED ?= 1
COMPILE_TIMEOUT_S ?= 600
SIM_TIMEOUT_S ?= 1800
SIMV_ARGS ?=

run: compile
	@echo "[Makefile] run TEST=$(TEST) AUTO_TXN_N=$(AUTO_TXN_N) SIM_SEED=$(SIM_SEED) TIMEOUT_S=$(SIM_TIMEOUT_S)"
	@bash -lc 'set -euo pipefail; \
	  run_dir="$(CURDIR)"; simv_path="$$run_dir/simv"; \
	  # Run from REPO_ROOT so relative plusargs (e.g. +stimuli=scripts/...) resolve deterministically. \
	  if [ -n "$(REPO_ROOT)" ] && [ -d "$(REPO_ROOT)" ]; then cd "$(REPO_ROOT)"; fi; \
	  cmd="$$simv_path +UVM_TESTNAME=$(TEST) +AUTO_TXN_N=$(AUTO_TXN_N) +ntb_random_seed=$(SIM_SEED) -cm line+cond+fsm+tgl+branch -cm_dir simv.vdb $(SIMV_ARGS)"; \
	  if command -v stdbuf >/dev/null 2>&1; then cmd="stdbuf -oL -eL $$cmd"; fi; \
	  if command -v timeout >/dev/null 2>&1; then cmd="timeout --preserve-status -k 10s $(SIM_TIMEOUT_S)s $$cmd"; fi; \
	  eval "$$cmd" 2>&1 | tee "$$run_dir/sim.log"'

# Generate coverage report using URG
COV_REPORT_DIR ?= coverage_report

cov_report: run
	@echo "[Makefile] Generating coverage report in $(COV_REPORT_DIR)"
	@if [ -d simv.vdb ]; then \
	    urg -dir simv.vdb -format both -report $(COV_REPORT_DIR); \
	    echo "[Makefile] Coverage report generated: $(COV_REPORT_DIR)/index.html"; \
	else \
	    echo "[Makefile] Error: simv.vdb not found. Run 'make run' first."; \
	    exit 1; \
	fi

# Extract coverage metrics to JSON
cov_json: run
	@echo "[Makefile] Extracting coverage metrics to coverage_metrics.json"
	@if [ -d simv.vdb ]; then \
	    urg -dir simv.vdb -format text -report coverage_text_report > /dev/null 2>&1; \
	    grep -E '(Line|Branch|Condition|Toggle|FSM) Coverage' coverage_text_report/hierarchy.txt | \
	    awk '{print "{\"" $$1 "_coverage\": " $$NF "}"}' > coverage_metrics.json 2>/dev/null || echo '{}' > coverage_metrics.json; \
	    echo "[Makefile] Coverage metrics saved to coverage_metrics.json"; \
	else \
	    echo "[Makefile] Error: simv.vdb not found. Run 'make run' first."; \
	    exit 1; \
	fi

clean:
	rm -rf csrc simv* *.log *.vpd *.key simv.vdb coverage_report coverage_text_report coverage_metrics.json